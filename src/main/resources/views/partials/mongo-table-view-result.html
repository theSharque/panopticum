<div id="table-data" class="query-result">
    <p th:if="${error}" th:text="${msg != null && msg[error] != null ? msg[error] : error}" class="query-error"></p>
    <div th:if="${error == null and columns != null and !columns.isEmpty()}" class="query-result-data">
        <div class="query-pagination-info" th:if="${rows != null and !rows.isEmpty()}">
            <span class="query-pagination-range" th:text="${msg['common.rowsRange'] + fromRow + '–' + toRow}"></span>
            <span class="query-pagination-nav">
                <form class="query-pagination-form"
                      th:action="@{/mongo/{id}/query(id=${connectionId})}"
                      method="post"
                      th:attr="hx-post=@{/mongo/{id}/query(id=${connectionId})}"
                      hx-target="#table-data"
                      hx-swap="outerHTML">
                    <input type="hidden" name="query" th:value="${query}"/>
                    <input type="hidden" name="dbName" th:value="${dbName}"/>
                    <input type="hidden" name="collection" th:value="${collection}"/>
                    <input type="hidden" name="limit" th:value="${limit}"/>
                    <input type="hidden" name="sort" th:value="${sort}"/>
                    <input type="hidden" name="order" th:value="${order}"/>
                    <input type="hidden" name="target" value="table"/>
                    <input type="hidden" name="offset" th:value="${prevOffset}"/>
                    <button type="submit" class="query-pagination-btn" th:classappend="${!hasPrev} ? 'query-pagination-btn-disabled' : ''" th:disabled="${!hasPrev}" th:text="${'← ' + msg['common.prev']}">← Back</button>
                </form>
                <form class="query-pagination-form"
                      th:action="@{/mongo/{id}/query(id=${connectionId})}"
                      method="post"
                      th:attr="hx-post=@{/mongo/{id}/query(id=${connectionId})}"
                      hx-target="#table-data"
                      hx-swap="outerHTML">
                    <input type="hidden" name="query" th:value="${query}"/>
                    <input type="hidden" name="dbName" th:value="${dbName}"/>
                    <input type="hidden" name="collection" th:value="${collection}"/>
                    <input type="hidden" name="limit" th:value="${limit}"/>
                    <input type="hidden" name="sort" th:value="${sort}"/>
                    <input type="hidden" name="order" th:value="${order}"/>
                    <input type="hidden" name="target" value="table"/>
                    <input type="hidden" name="offset" th:value="${nextOffset}"/>
                    <button type="submit" class="query-pagination-btn" th:classappend="${!hasMore} ? 'query-pagination-btn-disabled' : ''" th:disabled="${!hasMore}" th:text="${msg['common.next'] + ' →'}">Next →</button>
                </form>
            </span>
        </div>
        <div class="query-table-wrapper">
            <table class="query-table">
                <thead>
                    <tr>
                        <th class="query-th query-th-detail"></th>
                        <th th:each="col : ${columns}" class="query-th query-th-sortable">
                            <form th:if="${sort != col or sort == null}"
                                  th:action="@{/mongo/{id}/query(id=${connectionId})}"
                                  method="post"
                                  th:attr="hx-post=@{/mongo/{id}/query(id=${connectionId})}"
                                  hx-target="#table-data"
                                  hx-swap="outerHTML"
                                  class="query-th-form">
                                <input type="hidden" name="query" th:value="${query}"/>
                                <input type="hidden" name="dbName" th:value="${dbName}"/>
                                <input type="hidden" name="collection" th:value="${collection}"/>
                                <input type="hidden" name="offset" value="0"/>
                                <input type="hidden" name="limit" th:value="${limit}"/>
                                <input type="hidden" name="sort" th:value="${col}"/>
                                <input type="hidden" name="order" value="asc"/>
                                <input type="hidden" name="target" value="table"/>
                                <button type="submit" class="query-th-link" th:text="${col}"></button>
                            </form>
                            <form th:if="${sort == col and order == 'asc'}"
                                  th:action="@{/mongo/{id}/query(id=${connectionId})}"
                                  method="post"
                                  th:attr="hx-post=@{/mongo/{id}/query(id=${connectionId})}"
                                  hx-target="#table-data"
                                  hx-swap="outerHTML"
                                  class="query-th-form">
                                <input type="hidden" name="query" th:value="${query}"/>
                                <input type="hidden" name="dbName" th:value="${dbName}"/>
                                <input type="hidden" name="collection" th:value="${collection}"/>
                                <input type="hidden" name="offset" value="0"/>
                                <input type="hidden" name="limit" th:value="${limit}"/>
                                <input type="hidden" name="sort" th:value="${col}"/>
                                <input type="hidden" name="order" value="desc"/>
                                <input type="hidden" name="target" value="table"/>
                                <button type="submit" class="query-th-link" th:text="${col}"></button>
                            </form>
                            <form th:if="${sort == col and order == 'desc'}"
                                  th:action="@{/mongo/{id}/query(id=${connectionId})}"
                                  method="post"
                                  th:attr="hx-post=@{/mongo/{id}/query(id=${connectionId})}"
                                  hx-target="#table-data"
                                  hx-swap="outerHTML"
                                  class="query-th-form">
                                <input type="hidden" name="query" th:value="${query}"/>
                                <input type="hidden" name="dbName" th:value="${dbName}"/>
                                <input type="hidden" name="collection" th:value="${collection}"/>
                                <input type="hidden" name="offset" value="0"/>
                                <input type="hidden" name="limit" th:value="${limit}"/>
                                <input type="hidden" name="sort" th:value="${col}"/>
                                <input type="hidden" name="order" value="asc"/>
                                <input type="hidden" name="target" value="table"/>
                                <button type="submit" class="query-th-link" th:text="${col}"></button>
                            </form>
                            <span th:if="${sort == col and order == 'asc'}" class="query-sort-ind" title="ASC"> ▲</span>
                            <span th:if="${sort == col and order == 'desc'}" class="query-sort-ind" title="DESC"> ▼</span>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="row, rowStat : ${rows}" th:with="currentDocId=${docIds != null and rowStat.index < docIds.size() ? docIds.get(rowStat.index) : null}" class="query-data-row query-row-clickable"
                        onclick="var a = this.querySelector('a.query-detail-link'); if (a && !event.target.closest('a')) location.href = a.href;">
                        <td class="query-detail-cell">
                            <a th:if="${currentDocId != null and !currentDocId.isEmpty()}"
                               th:href="@{/mongo/{id}/{dbName}/detail(id=${connectionId}, dbName=${dbName}, collection=${collection}, docId=${currentDocId})}"
                               class="query-detail-link" th:attr="aria-label=${msg['common.open']}, title=${msg['common.open']}">
                                <svg class="icon-link" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                            </a>
                            <span th:if="${currentDocId == null or currentDocId.isEmpty()}"
                                  class="text-dim">—</span>
                        </td>
                        <td th:each="cell : ${row}" th:text="${cell}"></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <p th:if="${error == null and (rows == null or rows.isEmpty())}" class="text-dim" th:text="${msg['common.noData']}">No data.</p>
</div>
